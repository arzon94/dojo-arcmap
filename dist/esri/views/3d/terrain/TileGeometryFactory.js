//>>built
define("../webgl-engine/lib/Geometry ../webgl-engine/lib/GeometryData ../lib/glMatrix ../support/earthUtils ../support/mathUtils ./TerrainConst".split(" "),function(Z,aa,ba,ca,M,J){function P(h,e,f,g,c){h<g[0]&&(g[0]=h);h>c[0]&&(c[0]=h);e<g[1]&&(g[1]=e);e>c[1]&&(c[1]=e);f<g[2]&&(g[2]=f);f>c[2]&&(c[2]=f)}function R(h,e,f){for(var g=0;g<f.length;g++){var c=f[g];if(c){var b=c.safeWidth,r=c.width,n=c.pixelData,l=M.clamp(c.dy*(c.y1-e),0,b),c=M.clamp(c.dx*(h-c.x0),0,b),b=Math.floor(l),a=Math.floor(c),t=
b*r+a,w=t+r,F=n[t],r=n[w],t=n[t+1],n=n[w+1];if(F+r+t+n<.5*J.ELEVATION_NODATA_VALUE)return l-=b,c-=a,h=F+(t-F)*c,h+(r+(n-r)*c-h)*l}}return null}var S=ca.earthRadius,H=ba.vec3d,da=M.lerp,ea=function(){var h,e,f,g=H.create(),c=H.create(),b=H.create();this.init=function(r,n){e=r;f=n;H.subtract(b,c,g);h=.5*H.length(g);H.lerp(c,b,.5,g)};this.getCenter=function(){return g};this.getBSRadius=function(){return h};this.getBBMin=function(){return c};this.getBBMax=function(){return b};this.getPosition=function(){return e};
this.getIndices=function(){return f};this.getPrimitiveIndices=function(){};this.getChildren=function(){}},T=function(h,e,f,g){h*=S;for(var c=0;e>=c;c++)f[5*g]=0,f[5*g+1]=0,f[5*g+2]=h,g++},Q=new function(){var h=Array(50),e=0,f={};this.get=function(c){var b=f[c];b||(b={ptr:0,data:Array(50)},f[c]=b);var r;if(0<b.ptr?(g.vertexArrayHits++,r=b.data[--b.ptr],b.data[b.ptr]=null):(g.vertexArrayMisses++,r=new Float32Array(c)),0<e)return g.geometryHits++,c=h[--e],h[e]=null,c.getData().getVertexAttr().terrain.data=
r,c;g.geometryMisses++;c={};c.terrain={size:5,data:r};r=new ea;return new Z(new aa([{type:"triangle",indices:{terrain:null},positionKey:"terrain"}],c),"tile",[r])};this.put=function(c){var b=c.getData(),g=b.getVertexAttr(),n=g.terrain.data,l=f[n.length];50>l.ptr&&(l.data[l.ptr++]=n);g.terrain.data=null;b.getFaces()[0].indices.terrain=null;50>e&&(h[e++]=c)};var g={geometryHits:0,geometryMisses:0,vertexArrayHits:0,vertexArrayMisses:0};this.stats=g;this._pools={geometry:h,vertexArray:f}},O=[],U=Array(J.MAX_TILE_TESSELATION+
1),V=Array(J.MAX_TILE_TESSELATION+1),W=Array(J.MAX_TILE_TESSELATION+1),X=Array(J.MAX_TILE_TESSELATION+1),fa={values:null,numSurfaceIndices:0,numSkirtIndices:0},N=function(h,e,f){return f||(h.values=e.values),h.numSurfaceIndices=e.numSurfaceIndices,h.numSkirtIndices=e.numSkirtIndices,h},Y=function(h,e,f,g,c){var b;b=fa;var r=2&f,n=e+(g?1024:0)+(r?2048:0),l=O[n];if(b||(b={}),l)b=(N(b,l),b);else{var a,l=e-1,t=e-1,w=e*e;a=2*l+2*t;var F=l*t*6,B=6*a,x=6*(2*l+t-1);g&&(F*=2,B*=2,x*=2);a=65536<w+a?new Uint32Array(F+
B):new Uint16Array(F+B);for(var q,C,k,y,G=0,p=0,m=F,z=0,u=0;t>=u;u++){r&&(z=0===u?x:u===t?-x:0);for(var m=m+z,d=0;l>=d;d++){var v=-1,D=-1;if(0===u&&(v=w+d,d!==l&&(D=G+1)),d===l&&(v=w+l+u,t>u&&(D=G+l+1)),u===t&&(v=w+l+t+(l-d),0<d&&(D=G-1)),0===d&&0<u&&(v=w+2*l+t+(t-u),D=G-(l+1)),-1<v){var E=0===d&&1===u?w:v+1;-1<D&&(q=G,C=v,k=E,y=D,g?(a[m+0]=q,a[m+1]=C,a[m+2]=C,a[m+3]=k,a[m+4]=k,a[m+5]=q,a[m+6]=k,a[m+7]=y,a[m+8]=y,a[m+9]=q,a[m+10]=q,a[m+11]=k,m+=12):(a[m+0]=q,a[m+1]=C,a[m+2]=k,a[m+3]=k,a[m+4]=y,a[m+
5]=q,m+=6))}++G;l>d&&t>u&&(q=u*(l+1)+d,C=q+1,k=C+(l+1),y=k-1,g?(a[p+0]=q,a[p+1]=C,a[p+2]=C,a[p+3]=k,a[p+4]=k,a[p+5]=q,a[p+6]=k,a[p+7]=y,a[p+8]=y,a[p+9]=q,a[p+10]=q,a[p+11]=k,p+=12):(a[p+0]=q,a[p+1]=C,a[p+2]=k,a[p+3]=k,a[p+4]=y,a[p+5]=q,p+=6))}m-=z}b=(b.values=a,b.numSurfaceIndices=F,b.numSkirtIndices=B,O[n]=N({},b),b)}r=h.getData();n=r.getVertexAttr();return r.getFaces()[0].indices.terrain=b.values,h.getBoundingInfo(0).init(n.terrain,b.values),c||(c={}),c.geometry=h,c.numWithoutSkirtIndices=b.numSurfaceIndices+
(f?6*(e-1)*(g?2:1):0),c.numVertsPerRow=e,N(c,b,!0)};return{createPlanarGlobeTile:function(h,e,f,g,c,b,r){var n,l,a=e[0],t=e[1],w=e[2]-a;e=e[3]-t;var F=.1*w,B=h-1,x=h-1,q=h*h,C=Q.get(5*(q+(2*B+2*x))),k=C.getData().getVertexAttr().terrain.data,y=0;n=C.getBoundingInfo(0);var G=n.getBBMin(),p=n.getBBMax();H.set3(1E7,1E7,1E7,G);H.set3(-1E7,-1E7,-1E7,p);for(l=0;x>=l;l++){var m=l/x,z=t+m*e;b&&(z<b[1]?(z=b[1],m=(z-t)/e):z>b[3]&&(z=b[3],m=(z-t)/e));for(n=0;B>=n;n++){var u=n/B,d=a+u*w;b&&(d<b[0]?(d=b[0],u=
(d-a)/w):d>b[2]&&(d=b[2],u=(d-a)/w));var v=f?R(d,z,f)||0:0,d=d-g[0],D=z-g[1],v=v-g[2];P(d,D,v,G,p);k[5*y]=d;k[5*y+1]=D;k[5*y+2]=v;k[5*y+3]=u;k[5*y+4]=m;var E=-1;0===l&&(E=q+n);n===B&&(E=q+B+l);l===x&&(E=q+B+x+(B-n));0===n&&0<l&&(E=q+2*B+x+(x-l));-1<E&&(k[5*E]=d,k[5*E+1]=D,k[5*E+2]=v-F,k[5*E+3]=u,k[5*E+4]=m,P(d,D,v-F,G,p));++y}}return Y(C,h,0,c,r)},createSphericalGlobeTile:function(h,e,f,g,c,b,r,n,l){var a=f[0],t=f[1],w=f[2],F=f[3],B=Math.max(.9,1-.5*(w-a));f=h-1;var x=h-1,q=h*h,C=Q.get(5*(q+(2*f+
2*x))),k=C.getData().getVertexAttr().terrain.data,y=e[2]-e[0],G=e[3]-e[1],p=w-a,w=b[0],m=b[1];b=b[2];var z=C.getBoundingInfo(0),u=z.getBBMin(),z=z.getBBMax();H.set3(1E7,1E7,1E7,u);H.set3(-1E7,-1E7,-1E7,z);var d;for(d=0;f>=d;d++){var v=d/f,D=a+v*p;U[d]=Math.sin(D);V[d]=Math.cos(D);W[d]=v;X[d]=e[0]+v*y}for(a=y=0;x>=a;a++){var E,p=a/x;d=da(t,F,p);var D=Math.cos(d),J=Math.sin(d);g?(E=S/2*Math.log((1+J)/(1-J)),p=(E-e[1])/G):E=180*d/Math.PI;for(d=0;f>=d;d++){var v=W[d],K=U[d],L=V[d],I=S;c&&(I+=R(X[d],E,
c)||0);var L=L*D*I,K=K*D*I,I=J*I,M=L-w,N=K-m,O=I-b;P(M,N,O,u,z);var A=5*y;k[A+0]=M;k[A+1]=N;k[A+2]=O;k[A+3]=v;k[A+4]=p;A=-1;if(0===a&&(A=q+d),d===f&&(A=q+f+a),a===x&&(A=q+f+x+(f-d)),0===d&&0<a&&(A=q+2*f+x+(x-a)),-1<A)L=L*B-w,K=K*B-m,I=I*B-b,P(L,K,I,u,z),A*=5,k[A+0]=L,k[A+1]=K,k[A+2]=I,k[A+3]=v,k[A+4]=p;++y}}g&&(e=!!(2&r),1&r&&T(-1,f,k,q),e&&T(1,f,k,q+f+x));return Y(C,h,g?r:0,n,l)},releaseGeometry:Q.put,elevationSampler:R,_geometryObjectPool:Q}});