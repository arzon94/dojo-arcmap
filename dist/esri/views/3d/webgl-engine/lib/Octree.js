//>>built
define("require exports ./gl-matrix ./Util dojo/has ./PerformanceTimer".split(" "),function(v,F,A,q,B,C){function w(d,a,b){return b=b||d,b[0]=d[0]+a,b[1]=d[1]+a,b[2]=d[2]+a,b}var k=A.vec3d,x=B("dojo-debug-messages");v=function(){function d(a,b,c){this._maximumObjectsPerNode=10;this._maximumDepth=20;this._autoResize=!0;this._outsiders=[];c&&(void 0!==c.maximumObjectsPerNode&&(this._maximumObjectsPerNode=c.maximumObjectsPerNode),void 0!==c.maximumDepth&&(this._maximumDepth=c.maximumDepth),void 0!==
c.autoResize&&(this._autoResize=c.autoResize));isNaN(a[0])||isNaN(a[1])||isNaN(a[2])||isNaN(b)?this._root=new g(null,k.createFrom(0,0,0),.5):this._root=new g(null,a,b/2)}return Object.defineProperty(d.prototype,"center",{get:function(){return this._root.center},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"size",{get:function(){return 2*this._root.halfSize},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"root",{get:function(){return this._root.node},enumerable:!0,
configurable:!0}),Object.defineProperty(d.prototype,"outsiders",{get:function(){return this._outsiders.slice()},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"maximumObjectsPerNode",{get:function(){return this._maximumObjectsPerNode},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"maximumDepth",{get:function(){return this._maximumDepth},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"autoResize",{get:function(){return this._autoResize},enumerable:!0,
configurable:!0}),d.prototype.add=function(a){a=this._objectOrObjectsArray(a);this._grow(a);for(var b=g.acquire(),c=0;c<a.length;c++){var e=a[c];b.init(this._root);0===e.getBSRadius()||isNaN(e.getBSRadius())||!this._autoResize&&!this._fitsInsideTree(this._boundingSphereFromObject(e,t))?this._outsiders.push(e):this._add(e,b)}g.release(b)},d.prototype.remove=function(a,b){a=this._objectOrObjectsArray(a);for(var c=g.acquire(),e=!0,d=0;d<a.length;d++){var h=a[d],f=this._boundingSphereFromObject(b||h,
t);0===f.radius||isNaN(f.radius)||!this._autoResize&&!this._fitsInsideTree(f)?e=null!=q.arrayRemove(this._outsiders,h):(c.init(this._root),e=this._remove(h,f,c))}return g.release(c),this._shrink(),e},d.prototype.update=function(a,b){this.remove(a,b);this.add(a)},d.prototype.forEachAlongRay=function(a,b,c){this._forEachTest(function(c){return w(c.center,2*-c.halfSize,l),w(c.center,2*c.halfSize,m),q.rayBoxTest(a,b,l,m)},c)},d.prototype.forEachInBoundingBox=function(a,b,c){this._forEachTest(function(c){for(var e=
2*c.halfSize,d=0;3>d;d++)if(c.center[d]+e<a[d]||c.center[d]-e>b[d])return!1;return!0},c)},d.prototype.forEachNode=function(a){this._forEachNode(this._root,function(b){return a(b.node,b.center,2*b.halfSize)})},d.prototype._forEachTest=function(a,b){this._outsiders.forEach(b);this._forEachNode(this._root,function(c){return a(c)?(c=c.node,c.terminals.forEach(b),null!==c.residents&&c.residents.forEach(b),!0):!1})},d.prototype._forEachNode=function(a,b){a=g.acquire().init(a);for(var c=[a];0!==c.length;){if(a=
c.pop(),b(a)&&!a.isLeaf())for(var e=0;e<a.node.children.length;e++)a.node.children[e]&&c.push(g.acquire().init(a).advance(e));g.release(a)}},d.prototype._objectOrObjectsArray=function(a){return Array.isArray(a)||(y[0]=a,a=y),a},d.prototype._remove=function(a,b,c){p.length=0;var e,d;if(c.advanceTo(b,function(a,b){p.push(a.node,b)})?(e=null!=q.arrayRemove(c.node.terminals,a),d=0===c.node.terminals.length):(e=null!=q.arrayRemove(c.node.residents,a),d=0===c.node.residents.length),d)for(a=p.length-2;0<=
a&&this._purge(p[a],p[a+1]);a-=2);return e},d.prototype._nodeIsEmpty=function(a){if(0!==a.terminals.length)return!1;if(null!==a.residents)return 0===a.residents.length;for(var b=0;b<a.children.length;b++)if(a.children[b])return!1;return!0},d.prototype._purge=function(a,b){return 0<=b&&(a.children[b]=null),this._nodeIsEmpty(a)?(null===a.residents&&(a.residents=[]),!0):!1},d.prototype._add=function(a,b){b.advanceTo(this._boundingSphereFromObject(a,t))?b.node.terminals.push(a):(b.node.residents.push(a),
b.node.residents.length>this._maximumObjectsPerNode&&b.depth<this._maximumDepth&&this._split(b))},d.prototype._split=function(a){var b=a.node.residents;a.node.residents=null;for(var c=0;c<b.length;c++){var e=g.acquire().init(a);this._add(b[c],e);g.release(e)}},d.prototype._grow=function(a){if(0!==a.length&&this._autoResize&&(a=this._boundingSphereFromObjects(a,this._boundingSphereFromObject,n),!isNaN(a.radius)&&0!==a.radius&&!this._fitsInsideTree(a))){var b,c;if(x&&(b=new C(1),b.start()),this._nodeIsEmpty(this._root.node))k.set(a.center,
this._root.center),this._root.halfSize=1.25*a.radius,c="grow-empty";else{var e=g.acquire();this._rootBoundsForRootAsSubNode(a,e);this._placingRootViolatesMaxDepth(e)?(this._rebuildTree(a,e),c="rebuild"):(this._growRootAsSubNode(e),c="sub-node");g.release(e)}x&&(b=b.stop(),console.info("Octree grown in "+Math.round(b)+" ms (strategy: "+c+")"))}},d.prototype._rebuildTree=function(a,b){var c=this;k.set(b.center,u.center);u.radius=b.halfSize;a=this._boundingSphereFromObjects([a,u],function(a){return a},
D);b=g.acquire().init(this._root);this._root.initFrom(null,a.center,1.25*a.radius);this._forEachNode(b,function(a){return c.add(a.node.terminals),null!==a.node.residents&&c.add(a.node.residents),!0});g.release(b)},d.prototype._placingRootViolatesMaxDepth=function(a){var b=0;this._forEachNode(this._root,function(a){return b=Math.max(b,a.depth),!0});return b+Math.log(a.halfSize/this._root.halfSize)*Math.LOG2E>this._maximumDepth},d.prototype._rootBoundsForRootAsSubNode=function(a,b){var c=a.radius,e=
a.center;a=-(1/0);for(var d=this._root.center,h=this._root.halfSize,f=0;3>f;f++){var k=Math.max(0,Math.ceil((d[f]-h-(e[f]-c))/(2*h))),g=Math.max(0,Math.ceil((e[f]+c-(d[f]+h))/(2*h)))+1;a=Math.max(a,Math.pow(2,Math.ceil(Math.log(k+g)*Math.LOG2E)));r[f].min=k;r[f].max=g}for(f=0;3>f;f++)k=r[f].min,g=r[f].max,c=(a-(k+g))/2,k+=Math.ceil(c),g+=Math.floor(c),z[f]=d[f]-h-k*h*2+(g+k)*h;return b.initFrom(null,z,a*h,0)},d.prototype._growRootAsSubNode=function(a){var b=this._root.node;k.set(this._root.center,
n.center);n.radius=this._root.halfSize;this._root.init(a);a.advanceTo(n,null,!0);a.node.children=b.children;a.node.residents=b.residents;a.node.terminals=b.terminals},d.prototype._shrink=function(){if(this._autoResize)for(;;){var a=this._findShrinkIndex();if(-1===a)break;this._root.advance(a);this._root.depth=0}},d.prototype._findShrinkIndex=function(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;for(var a=null,b=this._root.node.children,c=0,e=0;e<b.length&&null==a;)c=e++,
a=b[c];for(;e<b.length;)if(b[e++])return-1;return c},d.prototype._fitsInsideTree=function(a){var b=this._root.center,c=this._root.halfSize,e=a.center;return c>=a.radius&&e[0]>=b[0]-c&&e[0]<=b[0]+c&&e[1]>=b[1]-c&&e[1]<=b[1]+c&&e[2]>=b[2]-c&&e[2]<=b[2]+c},d.prototype._boundingSphereFromObject=function(a,b){return k.set(a.getCenter(),b.center),b.radius=a.getBSRadius(),b},d.prototype._boundingSphereFromObjects=function(a,b,c){if(1===a.length){var e=b(a[0],n);k.set(e.center,c.center);c.radius=e.radius}else{l[0]=
1/0;l[1]=1/0;l[2]=1/0;m[0]=-(1/0);m[1]=-(1/0);m[2]=-(1/0);for(var d=0;d<a.length;d++){var e=b(a[d],n),h=l,f=e.center,g=e.radius;h[0]=Math.min(h[0],f[0]-g);h[1]=Math.min(h[1],f[1]-g);h[2]=Math.min(h[2],f[2]-g);h=m;f=e.center;e=e.radius;h[0]=Math.max(h[0],f[0]+e);h[1]=Math.max(h[1],f[1]+e);h[2]=Math.max(h[2],f[2]+e)}k.scale(k.add(l,m,c.center),.5);c.radius=Math.max(m[0]-l[0],m[1]-l[1],m[2]-l[2])/2}return c},d}();var g=function(){function d(a,b,c,d){void 0===c&&(c=0);void 0===d&&(d=0);this.center=k.create();
this.initFrom(a,b,c,0)}return d.prototype.init=function(a){return this.initFrom(a.node,a.center,a.halfSize,a.depth)},d.prototype.initFrom=function(a,b,c,e){return void 0===a&&(a=null),void 0===c&&(c=this.halfSize),void 0===e&&(e=this.depth),this.node=a||d.createEmptyNode(),b&&k.set(b,this.center),this.halfSize=c,this.depth=e,this},d.prototype.advance=function(a){var b=this.node.children[a];b||(b=d.createEmptyNode(),this.node.children[a]=b);this.node=b;this.halfSize/=2;this.depth++;a=E[a];return this.center[0]+=
a[0]*this.halfSize,this.center[1]+=a[1]*this.halfSize,this.center[2]+=a[2]*this.halfSize,this},d.prototype.advanceTo=function(a,b,c){for(void 0===c&&(c=!1);;){if(this.isTerminalFor(a))return b&&b(this,-1),!0;if(this.isLeaf()&&!c)return b&&b(this,-1),!1;this.isLeaf()&&(this.node.residents=null);var d=this._childIndex(a);b&&b(this,d);this.advance(d)}},d.prototype.isLeaf=function(){return null!=this.node.residents},d.prototype.isTerminalFor=function(a){return a.radius>this.halfSize/2},d.prototype._childIndex=
function(a){a=a.center;for(var b=this.center,c=0,d=0;3>d;d++)b[d]<a[d]&&(c|=1<<d);return c},d.createEmptyNode=function(){return{children:[null,null,null,null,null,null,null,null],terminals:[],residents:[]}},d.acquire=function(){if(0===this._pool.length)return new d;var a=this._pool[this._pool.length-1];return this._pool.length--,a},d.release=function(a){this._pool.push(a)},d}();g._pool=[];var E=[[-1,-1,-1],[1,-1,-1],[-1,1,-1],[1,1,-1],[-1,-1,1],[1,-1,1],[-1,1,1],[1,1,1]],y=[null],z=k.create(),l=k.create(),
m=k.create(),p=[],t={center:k.create(),radius:0},n={center:k.create(),radius:0},u={center:k.create(),radius:0},D={center:k.create(),radius:0},r=[{min:0,max:0},{min:0,max:0},{min:0,max:0}];return v});