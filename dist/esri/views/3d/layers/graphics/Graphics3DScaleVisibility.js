//>>built
define(["require","exports"],function(n,p){function g(c,a){return null!==c&&0<c&&8E7>c||1E3<a}return function(){function c(){this._scaleRangeActive=!1;this.layerScaleRangeVisibilityDirty=this.layerScaleRangeVisibility=!0;this.layerScaleRangeVisibilityQuery=!1;this.basemapTerrain=this.graphicsCore=this.extent=this.spatialIndex=this.layer=this.layerView=this.scaleChangeEventHandle=null}return c.prototype.initialize=function(a,b,d,c,h){this.layerView=a;this.layer=b;this.spatialIndex=d;this.graphicsCore=
c;this.basemapTerrain=h;this.updateScaleRangeActive()},c.prototype.destroy=function(){this.scaleChangeEventHandle&&(this.scaleChangeEventHandle.remove(),this.scaleChangeEventHandle=null);this.graphicsCore=this.spatialIndex=this.extent=this.layerView=null},c.prototype.needsIdleUpdate=function(){return this.layerView.view.basemapTerrain&&this.layerScaleRangeVisibilityDirty},c.prototype.canResume=function(){return this.layerScaleRangeVisibility},c.prototype.setExtent=function(a){this.extent=a;this.layerScaleRangeVisibilityDirty=
!0},c.prototype.idleUpdate=function(a){this.layerView.view.basemapTerrain&&(a.done()||this.layerScaleRangeVisibilityDirty&&(this.updateSuspendScaleVisible(),this.layerScaleRangeVisibilityDirty=!1))},c.prototype.scaleRangeActive=function(){return this._scaleRangeActive},c.prototype.updateScaleRangeActive=function(){var a=this;if(!this.spatialIndex)return this._scaleRangeActive=!1,!1;var b=this.layer,d=!1;b.labelingInfo&&(d=d||b.labelingInfo.some(function(a){return a&&g(a.minScale,a.maxScale)}));d=
d||g(b.minScale,b.maxScale);b=this._scaleRangeActive!==d;return this._scaleRangeActive=d,d&&!this.scaleChangeEventHandle&&this.basemapTerrain?this.scaleChangeEventHandle=this.basemapTerrain.on("scale-change",function(b){return a.scaleUpdateHandler(b)}):!d&&this.scaleChangeEventHandle&&(this.scaleChangeEventHandle.remove(),this.scaleChangeEventHandle=null),b},c.prototype.updateSuspendScaleVisibleFinish=function(a){this.layerScaleRangeVisibilityQuery=!1;this.layerScaleRangeVisibility!==a&&(this.layerScaleRangeVisibility=
a,this.layerView._notifySuspendedChange())},c.prototype.updateSuspendScaleVisible=function(){var a=this,b=this.layerView.view.basemapTerrain;this.extent&&b&&this._scaleRangeActive?this.layerScaleRangeVisibilityQuery||(this.layerScaleRangeVisibilityQuery=!0,b.queryVisibleScaleRange(this.extent,this.layer.minScale,this.layer.maxScale,function(b){return a.updateSuspendScaleVisibleFinish(b)})):this.updateSuspendScaleVisibleFinish(!0)},c.prototype.visibleAtScale=function(a,b,d){return null==a?!0:a>d&&
(!b||b>a)},c.prototype.visibleAtLayerScale=function(a){return this.visibleAtScale(a,this.layer.minScale,this.layer.maxScale)},c.prototype.visibleAtLabelScale=function(a,b){return this.visibleAtScale(a,b.minScale,b.maxScale)},c.prototype.graphicScale=function(a,b){var d;return(b.centroid?d=b.centroid:"point"===a.geometry.type&&(d=a.geometry),d)?this.layerView.view.basemapTerrain?this.layerView.view.basemapTerrain.getScale(d):1:null},c.prototype.graphicVisible=function(a,b){a=this.graphicScale(a,b);
return this.visibleAtLayerScale(a)},c.prototype.updateGraphicScaleVisibility=function(a,b){return this._scaleRangeActive?(b.addedToSpatialIndex||this.spatialIndex.addGraphicToSpatialIndex(a,b),a=this.graphicVisible(a,b),b.setVisibilityFlag(1,a)):!1},c.prototype.updateGraphicLabelScaleVisibility=function(a,b){if(!this._scaleRangeActive||!b._labelGraphics||0===b._labelGraphics.length)return!1;b.addedToSpatialIndex||this.spatialIndex.addGraphicToSpatialIndex(a,b);a=this.graphicScale(a,b);b=this.updateLabelScaleVisibility(b,
a);return b&&this.layerView.view.deconflictor.setDirty(),b},c.prototype.updateLabelScaleVisibility=function(a,b){if(!a._labelGraphics||0===a._labelGraphics.length)return!1;1<a._labelGraphics.length&&console.warn("Multiple label classes are not supported");var d=a._labelGraphics[0]._labelClass;return d&&null!=d.minScale&&null!=d.maxScale&&(b=this.visibleAtLabelScale(b,d),a.setVisibilityFlag(1,b,1))?!0:!1},c.prototype.scaleUpdateHandler=function(a){var b=this;if(!this.layerView.suspended&&this.spatialIndex.hasGraphics()){var d=
a.extent,c=a.scale;this.spatialIndex.intersects(d,a.spatialReference,function(a,g){for(var h=b.visibleAtLayerScale(c),l=!1,m=!1,k=0;g>k;k++){var f=b.graphicsCore.getGraphics3DGraphicById(a[k]);if(f){var e=f.centroid;e&&(d[0]>e.x||d[1]>e.y||d[2]<e.x||d[3]<e.y)||(e=!1,f.setVisibilityFlag(1,h)&&(e=!0),b.updateLabelScaleVisibility(f,c)&&(e=!0),e&&(m=!0,f.isDraped()&&(l=!0)))}}m&&b.layerView.view.deconflictor.setDirty();l&&b.layerView._notifyDrapedDataChange()})}this.layerScaleRangeVisibilityDirty=!0},
c.prototype.layerMinMaxScaleChangeHandler=function(){this.updateScaleRangeActive()&&(this._scaleRangeActive?this.graphicsCore.updateAllGraphicsVisibility():this.graphicsCore.forEachGraphics3DGraphic(function(a){return a.setVisibilityFlag(1,void 0)}));this.layerScaleRangeVisibilityDirty=!0},c}()});