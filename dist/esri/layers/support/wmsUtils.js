//>>built
define(["require","exports","../../geometry/Extent","../../geometry/SpatialReference","../../core/urlUtils"],function(J,l,y,u,G){function v(a){return H.some(function(b){var c=b[1];return a>=b[0]&&c>=a})}function B(a){var b=[];return a.forEach(function(a){b.push(a);a.sublayers&&a.sublayers.length&&(b=b.concat(B(a.sublayers)),delete a.sublayers)}),b}function A(a,b,c,e){return(a=g(a,c))?a.getAttribute(b):e}function g(a,b){return(a=b&&b.getElementsByTagName(a))&&0<a.length?a[0]:null}function k(a,b,c){return(a=
g(a,b))?a.textContent:c}function m(a,b,c){if(!a)return null;var e,h,f,g,q=parseFloat(a.getAttribute("minx")),r=parseFloat(a.getAttribute("miny")),d=parseFloat(a.getAttribute("maxx"));a=parseFloat(a.getAttribute("maxy"));c?(e=isNaN(r)?-Number.MAX_VALUE:r,h=isNaN(q)?-Number.MAX_VALUE:q,f=isNaN(a)?Number.MAX_VALUE:a,g=isNaN(d)?Number.MAX_VALUE:d):(e=isNaN(q)?-Number.MAX_VALUE:q,h=isNaN(r)?-Number.MAX_VALUE:r,f=isNaN(d)?Number.MAX_VALUE:d,g=isNaN(a)?Number.MAX_VALUE:a);b=new u({wkid:b});return new y({xmin:e,
ymin:h,xmax:f,ymax:g,spatialReference:b})}function C(a,b){a=g(b,a);if(a=g("DCPType",a))if(a=g("HTTP",a))if(a=g("Get",a)){var c=A("OnlineResource","xlink:href",a,null);if(c){c.indexOf("\x26")===c.length-1&&(c=c.substring(0,c.length-1));a=["service","request"];b=[];var c=G.urlToObject(c),e;for(e in c.query)c.query.hasOwnProperty(e)&&-1===a.indexOf(e.toLowerCase())&&b.push(e+"\x3d"+c.query[e]);return c.path+(b.length?"?"+b.join("\x26"):"")}}return null}function D(a,b){var c=a.getElementsByTagName("Operation");
if(c&&c.length){var e=[];return Array.prototype.slice.call(c).forEach(function(a){a.getAttribute("name")===b&&(a=a.getElementsByTagName("Format"),Array.prototype.slice.call(a).forEach(function(a){e.push(a.textContent)}))}),e}a=g(b,a).getElementsByTagName("Format");return Array.prototype.slice.call(a).map(function(a){return a.textContent})}function w(a,b){if(!a)return null;var c={id:I++,fullExtents:[],parentLayerId:null,queryable:"1"===a.getAttribute("queryable"),spatialReferences:[],sublayers:null},
e=g("LatLonBoundingBox",a),h=g("EX_GeographicBoundingBox",a),f=null;e&&(f=m(e,4326));h&&(f=new y(0,0,0,0,new u({wkid:4326})),f.xmin=parseFloat(k("westBoundLongitude",h,0)),f.ymin=parseFloat(k("southBoundLatitude",h,0)),f.xmax=parseFloat(k("eastBoundLongitude",h,0)),f.ymax=parseFloat(k("northBoundLatitude",h,0)));e||h||(f=new y(-180,-90,180,90,new u({wkid:4326})));var l=-1<["1.0.0","1.1.0","1.1.1"].indexOf(b)?"SRS":"CRS";return Array.prototype.slice.call(a.childNodes).forEach(function(a){if("Name"===
a.nodeName)c.name=a.textContent||"";else if("Title"===a.nodeName)c.title=a.textContent||"";else if("Abstract"===a.nodeName)c.description=a.textContent||"";else if("BoundingBox"===a.nodeName){var e=a.getAttribute(l);if(e&&0===e.indexOf("EPSG:")){var d=parseInt(e.substring(5),10);0===d||isNaN(d)||f||(f="1.3.0"===b?m(a,d,v(d)):m(a,d))}(d=e&&e.indexOf(":"))&&-1<d&&(d=parseInt(e.substring(d+1,e.length),10),0===d||isNaN(d)||(d=p[d]?p[d]:d),a="1.3.0"===b?m(a,d,v(d)):m(a,d),c.fullExtents.push(a))}else a.nodeName===
l?a.textContent.split(" ").forEach(function(a){a=-1<a.indexOf(":")?parseInt(a.split(":")[1],10):parseInt(a,10);0===a||isNaN(a)||(p[a]&&(a=p[a]),-1===c.spatialReferences.indexOf(a)&&c.spatialReferences.push(a))}):"Style"!==a.nodeName||c.legendURL?"Layer"===a.nodeName&&(a=w(a,b))&&(a.parentLayerId=c.id,c.sublayers||(c.sublayers=[]),c.sublayers.push(a)):(a=g("LegendURL",a))&&(a=g("OnlineResource",a))&&(c.legendURL=a.getAttribute("xlink:href"))}),c.extent=f&&f.toJSON(),c}Object.defineProperty(l,"__esModule",
{value:!0});var H=[[4001,4999],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3416,3416],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],
[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]],p={84:4326,83:4269,27:4267},I=-1;l.parseCapabilities=function(a){if(a){"string"==typeof a&&(a=(new DOMParser).parseFromString(a,"text/xml"));var b=a.documentElement,c=g("Layer",b);if(c){var e,h=A("WMS_Capabilities","version",b,null)||A("WMT_MS_Capabilities","version",b,"1.3.0"),f=g("Service",b);a=k("Title",f,"")||k("Name",f,"");var l=
k("AccessConstraints",f,""),q=k("Abstract",f,""),r=parseInt(k("MaxWidth",f,5E3),10),f=parseInt(k("MaxHeight",f,5E3),10),d=w(c,h),m=0,c=g("Capability",b);if(Array.prototype.slice.call(c.childNodes).forEach(function(a){"Layer"===a.nodeName&&(0===m?e=a:1===m?(d.name&&(d.name="",d.sublayers.push(w(e,h))),d.sublayers.push(w(a,h))):d.sublayers.push(w(a,h)),m++)}),!d)return null;var t,x,n=[],c=d.fullExtents;(n=d.sublayers,n&&0!==n.length||n.push(d),t=d.extent,t)||(t=new y(n[0].extent),d.extent=t.toJSON(),
t=d.extent);if(x=d.spatialReferences,!x.length&&0<n.length){var p=function(a){var b=[];return a.sublayers.forEach(function(a){!b.length&&a.spatialReferences.length&&(b=a.spatialReferences||p(a))}),b};n.forEach(function(a){x.length||(x=a.spatialReferences||p(a))})}var z,u=C(b,"GetMap"),v=D(b,"GetMap"),E=C(b,"GetFeatureInfo");E&&(b=D(b,"GetFeatureInfo"),-1<b.indexOf("text/html")?z="text/html":-1<b.indexOf("text/plain")&&(z="text/plain"));if(!z){var F=function(a){a&&(a.queryable=!1,a.sublayers&&a.sublayers.forEach(function(a){F(a)}))};
F(d)}b=B(n);return{copyright:l,description:q,extent:t,fullExtents:c,featureInfoFormat:z,featureInfoUrl:E,mapUrl:u,maxImageWidth:r,maxImageHeight:f,layers:b,spatialReferences:x,supportedImageFormatTypes:v,title:a,version:h}}}};l.coordsReversed=v;l.getPopupLayers=function(a){return a.length?a.filter(function(a){return a.popupEnabled&&a.name&&a.queryable}).map(function(a){return a.name}).join(","):""}});